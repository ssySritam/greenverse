<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <title>Forest Atlas — Explore the world's jungles</title>
    <meta name="description" content="A living atlas of the world's forests: 3D canopy, immersive UI, rich data, infinite scroll, and AI insights." />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Playfair+Display:wght@600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0b0f12;
            --fg: #e6f2ea;
            --muted: #9fb5a8;
            --accent: #38b000;
            --accent-2: #70e000;
            --card: rgba(18, 24, 20, 0.65);
            --glass: rgba(20, 24, 22, 0.35);
            --border: rgba(255,255,255,0.08);
            --shadow: 0 8px 30px rgba(0,0,0,0.35);
            --blur: saturate(140%) blur(8px);
            --ring: 0 0 0 2px var(--accent);
            --link: #8ef37f;
            --warn: #f59e0b;
            --danger: #ef4444;
        }

        [data-theme="light"] {
            --bg: #f5faf7;
            --fg: #0e1a12;
            --muted: #4b6657;
            --accent: #2a9d8f;
            --accent-2: #7fd3c9;
            --card: rgba(255,255,255,0.70);
            --glass: rgba(255,255,255,0.45);
            --border: rgba(0,0,0,0.08);
            --shadow: 0 8px 30px rgba(0,0,0,0.15);
            --link: #0ea5e9;
        }

        [data-theme="lush"] {
            --bg: #08110a;
            --fg: #eaffeb;
            --muted: #a6d3b5;
            --accent: #00ff9c;
            --accent-2: #19ffa0;
            --card: rgba(10, 18, 12, 0.65);
            --glass: rgba(12, 20, 14, 0.45);
            --border: rgba(0,255,156,0.15);
            --shadow: 0 10px 40px rgba(0,255,156,0.09);
            --link: #7cffe1;
        }

        * {
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
        }

        body {
            margin: 0;
            background: radial-gradient(1200px 600px at 70% 30%, rgba(56,176,0,0.08), transparent 60%), var(--bg);
            color: var(--fg);
            font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden;
        }

        /* 3D canvas backdrop */
        #scene {
            position: fixed;
            inset: 0;
            z-index: 0;
            background: radial-gradient(1200px 600px at 30% 70%, rgba(56,176,0,0.05), transparent 60%);
        }

        .fog {
            position: fixed;
            inset: 0;
            z-index: 1;
            pointer-events: none;
            background: radial-gradient(800px 400px at 50% 20%, rgba(255,255,255,0.035), transparent 70%), radial-gradient(1200px 600px at 10% 80%, rgba(255,255,255,0.02), transparent 70%);
            mix-blend-mode: screen;
        }

        /* Layout */
        .app {
            position: relative;
            z-index: 2;
            display: grid;
            grid-template-rows: auto 1fr auto;
            min-height: 100vh;
            overflow: hidden;
        }

        header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
            backdrop-filter: var(--blur);
            background: var(--glass);
            border-bottom: 1px solid var(--border);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            letter-spacing: 0.3px;
        }

            .logo .mark {
                width: 28px;
                height: 28px;
                border-radius: 10px;
                background: linear-gradient(135deg, var(--accent), var(--accent-2));
                box-shadow: 0 6px 18px rgba(56,176,0, 0.45);
            }

        .title {
            font-family: "Playfair Display", serif;
            font-size: 20px;
        }

        .actions {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .theme {
            display: inline-flex;
            gap: 6px;
            padding: 6px;
            border: 1px solid var(--border);
            border-radius: 12px;
            background: var(--card);
        }

            .theme button {
                all: unset;
                padding: 6px 10px;
                border-radius: 8px;
                color: var(--muted);
                cursor: pointer;
            }

                .theme button.active {
                    background: linear-gradient(135deg, var(--accent), var(--accent-2));
                    color: #09200f;
                    font-weight: 600;
                }

        /* Search bar */
        .searchbar {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            padding: 14px 20px;
            border-bottom: 1px solid var(--border);
            backdrop-filter: var(--blur);
            background: var(--glass);
        }

        .search {
            position: relative;
        }

            .search input {
                width: 100%;
                padding: 12px 14px 12px 40px;
                border-radius: 12px;
                border: 1px solid var(--border);
                background: var(--card);
                color: var(--fg);
                outline: none;
                transition: border-color 160ms ease, box-shadow 180ms ease;
            }

                .search input:focus {
                    border-color: var(--accent);
                    box-shadow: var(--ring);
                }

            .search .icon {
                position: absolute;
                left: 12px;
                top: 50%;
                transform: translateY(-50%);
                width: 18px;
                height: 18px;
                opacity: 0.8;
            }

        .suggestions {
            position: absolute;
            top: calc(100% + 6px);
            left: 0;
            right: 0;
            background: var(--card);
            backdrop-filter: var(--blur);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: var(--shadow);
            max-height: 300px;
            overflow: auto;
            display: none;
            z-index: 10;
        }

            .suggestions.open {
                display: block;
            }

            .suggestions .item {
                padding: 10px 12px;
                cursor: pointer;
                border-bottom: 1px solid var(--border);
            }

                .suggestions .item:last-child {
                    border-bottom: none;
                }

                .suggestions .item:hover, .suggestions .item.active {
                    background: linear-gradient(135deg, rgba(56,176,0,0.12), transparent);
                }

        .filters {
            display: flex;
            gap: 10px;
        }

        .chip {
            padding: 10px 12px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: var(--card);
            color: var(--muted);
            cursor: pointer;
            transition: transform 140ms ease, background 160ms ease;
        }

            .chip.active {
                background: linear-gradient(135deg, var(--accent), var(--accent-2));
                color: #09200f;
                font-weight: 600;
            }

        /* Main content */
        main {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 14px;
            padding: 14px;
            height: calc(100vh - 160px);
            overflow: hidden;
        }

        .feed {
            position: relative;
            overflow: auto;
            padding-right: 6px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 12px;
        }

        @media (max-width: 1200px) {
            main {
                grid-template-columns: 1fr;
            }

            .details {
                display: none;
            }

            .grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }

        @media (max-width: 700px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }

        .card {
            position: relative;
            overflow: hidden;
            border-radius: 14px;
            border: 1px solid var(--border);
            background: var(--card);
            box-shadow: var(--shadow);
            transform: translateY(8px);
            opacity: 0;
        }

            .card.revealed {
                transform: translateY(0);
                opacity: 1;
                transition: transform 360ms cubic-bezier(.2,.8,.2,1), opacity 360ms ease;
            }

        .thumb {
            position: relative;
            aspect-ratio: 16/9;
            overflow: hidden;
            background: #0a120c;
        }

            .thumb img {
                width: 100%;
                height: 100%;
                object-fit: cover;
                filter: saturate(115%) contrast(105%);
                transform: scale(1.02);
                transition: transform 600ms ease;
            }

        .card:hover .thumb img {
            transform: scale(1.05);
        }

        .overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.45), rgba(0,0,0,0.0) 60%);
        }

        .meta {
            padding: 12px 12px 14px;
            display: grid;
            gap: 6px;
        }

            .meta .name {
                font-weight: 700;
                letter-spacing: 0.2px;
            }

            .meta .place {
                color: var(--muted);
                font-size: 12px;
            }

        .tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 6px;
        }

        .tag {
            font-size: 11px;
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid var(--border);
            color: var(--muted);
            background: rgba(255,255,255,0.03);
        }

        .actions-row {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .btn {
            all: unset;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 10px;
            cursor: pointer;
            border: 1px solid var(--border);
            background: rgba(255,255,255,0.03);
            color: var(--fg);
        }

            .btn:hover {
                background: linear-gradient(135deg, rgba(56,176,0,0.2), transparent);
            }

        .loader {
            text-align: center;
            padding: 24px;
            color: var(--muted);
        }

        .sentinel {
            height: 40px;
        }

        /* Details side panel */
        .details {
            position: relative;
            overflow: auto;
            padding: 10px;
            border-left: 1px solid var(--border);
            backdrop-filter: var(--blur);
            background: var(--glass);
        }

            .details .cover {
                position: relative;
                aspect-ratio: 4/3;
                border-radius: 12px;
                overflow: hidden;
                border: 1px solid var(--border);
                box-shadow: var(--shadow);
            }

            .details .content {
                padding: 10px;
                display: grid;
                gap: 8px;
            }

        .tabs {
            display: flex;
            gap: 8px;
            margin: 8px 0;
        }

        .tab {
            padding: 8px 10px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: rgba(255,255,255,0.03);
            color: var(--muted);
            cursor: pointer;
        }

            .tab.active {
                background: linear-gradient(135deg, var(--accent), var(--accent-2));
                color: #09200f;
                font-weight: 600;
            }

        .tabpanel {
            display: none;
        }

            .tabpanel.active {
                display: block;
            }

        /* AI drawer */
        .ai {
            position: fixed;
            right: 14px;
            bottom: 14px;
            width: 380px;
            max-height: 60vh;
            display: grid;
            grid-template-rows: auto 1fr auto;
            padding: 10px;
            border-radius: 14px;
            border: 1px solid var(--border);
            background: var(--card);
            box-shadow: var(--shadow);
            z-index: 5;
        }

            .ai header {
                background: transparent;
                backdrop-filter: none;
                border: none;
                padding: 0;
            }

        .ai-log {
            overflow: auto;
            display: grid;
            gap: 10px;
            padding-right: 6px;
        }

        .ai-msg {
            border-radius: 10px;
            padding: 10px;
        }

        .ai-user {
            background: rgba(255,255,255,0.05);
        }

        .ai-assistant {
            background: rgba(56,176,0,0.12);
        }

        .ai input {
            width: 100%;
            padding: 10px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: var(--glass);
            color: var(--fg);
        }

        footer {
            padding: 14px 20px;
            border-top: 1px solid var(--border);
            backdrop-filter: var(--blur);
            background: var(--glass);
            color: var(--muted);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        a {
            color: var(--link);
            text-decoration: none;
        }

            a:hover {
                text-decoration: underline;
            }

        /* Small icon */
        .i {
            width: 16px;
            height: 16px;
            opacity: 0.8;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
    </style>
</head>
<body data-theme="lush">
    <canvas id="scene"></canvas>
    <div class="fog"></div>

    <div class="app">
        <header>
            <div class="logo">
                <div class="mark" aria-hidden="true"></div>
                <div class="title">Forest Atlas</div>
            </div>
            <div class="actions">
                <div class="theme" role="tablist" aria-label="Theme">
                    <button class="active" data-set-theme="lush" role="tab" aria-selected="true">Lush</button>
                    <button data-set-theme="dark" role="tab" aria-selected="false">Dark</button>
                    <button data-set-theme="light" role="tab" aria-selected="false">Light</button>
                </div>
                <button class="btn" id="shuffleBtn"><svg class="i" viewBox="0 0 24 24"><path fill="currentColor" d="M17 3h4v4h-2V5h-2V3M7 3H3v4h2V5h2V3m10 16h2v-2h2v4h-4v-2M5 17H3v4h4v-2H5v-2M7 13h2l2 2l4-4l6 6v2h-2l-4-4l-4 4l-4-4H3v-2h4z" /></svg>Shuffle</button>
            </div>
        </header>

        <div class="searchbar">
            <div class="search">
                <svg class="icon" viewBox="0 0 24 24"><path fill="currentColor" d="M10 2a8 8 0 1 1 0 16a8 8 0 0 1 0-16m0 2a6 6 0 1 0 0 12a6 6 0 0 0 0-12m11 17l-6-6l1.4-1.4l6 6L21 21Z" /></svg>
                <input id="searchInput" type="text" placeholder="Search forests, jungles, biomes..." aria-autocomplete="list" aria-controls="suggestionsList" />
                <div id="suggestions" class="suggestions" role="listbox" aria-label="Suggestions"></div>
            </div>
            <div class="filters">
                <button class="chip active" data-filter="all">All</button>
                <button class="chip" data-filter="tropical">Tropical</button>
                <button class="chip" data-filter="temperate">Temperate</button>
                <button class="chip" data-filter="boreal">Boreal</button>
                <button class="chip" data-filter="mangrove">Mangrove</button>
                <button class="chip" data-filter="cloud">Cloud</button>
            </div>
        </div>

        <main>
            <div class="feed">
                <div id="grid" class="grid"></div>
                <div class="loader" id="loader" style="display:none;">Loading forests...</div>
                <div class="sentinel" id="sentinel"></div>
            </div>

            <aside class="details" id="details">
                <div class="cover">
                    <img id="detailsImg" alt="Forest cover" referrerpolicy="no-referrer" />
                    <div class="overlay"></div>
                </div>
                <div class="content">
                    <h3 id="detailsName" style="margin:6px 0 0">Select a forest</h3>
                    <div id="detailsPlace" class="muted" style="color:var(--muted)">—</div>
                    <div class="tabs">
                        <button class="tab active" data-tab="overview">Overview</button>
                        <button class="tab" data-tab="species">Species</button>
                        <button class="tab" data-tab="ecology">Ecology</button>
                        <button class="tab" data-tab="benefits">Benefits</button>
                    </div>
                    <div id="tab-overview" class="tabpanel active">
                        <p id="detailsSummary">Browse the atlas and open a forest to see details, history, and context.</p>
                        <div style="display:flex; gap:10px; margin-top:8px;">
                            <a id="wikiLink" href="#" target="_blank" rel="noopener">Wikipedia</a>
                            <a id="commonsLink" href="#" target="_blank" rel="noopener">Images</a>
                        </div>
                    </div>
                    <div id="tab-species" class="tabpanel">
                        <ul id="speciesList" style="margin:0; padding-left:18px;"></ul>
                    </div>
                    <div id="tab-ecology" class="tabpanel">
                        <p id="ecologyText">Primary productivity, nutrient cycles, rainfall interception, and canopy stratification vary by biome.</p>
                    </div>
                    <div id="tab-benefits" class="tabpanel">
                        <ul id="benefitsList" style="margin:0; padding-left:18px;"></ul>
                    </div>
                </div>
            </aside>
        </main>

        <div class="ai" id="ai">
            <header>
                <div style="display:flex; align-items:center; gap:8px;">
                    <svg class="i" viewBox="0 0 24 24"><path fill="currentColor" d="M12 2a7 7 0 0 1 7 7c0 4.418-3.582 9-7 13c-3.418-4-7-8.582-7-13a7 7 0 0 1 7-7m0 9a2 2 0 1 0 0-4a2 2 0 0 0 0 4Z" /></svg>
                    <strong>Forest AI Guide</strong>
                </div>
            </header>
            <div class="ai-log" id="aiLog" aria-live="polite"></div>
            <div style="display:flex; gap:8px; align-items:center;">
                <input id="aiInput" type="text" placeholder="Ask about ecology, species, climate..." />
                <button class="btn" id="aiSend"><svg class="i" viewBox="0 0 24 24"><path fill="currentColor" d="M2 21V3l20 9l-20 9Zm2-3.25L16.85 12L4 6.25v3.8L10.5 12L4 14.95v2.8Z" /></svg>Ask</button>
            </div>
        </div>

        <footer>
            <div>Made with care for living landscapes</div>
            <div>
                <a href="https://commons.wikimedia.org/wiki/Main_Page" target="_blank" rel="noopener">Wikimedia Commons</a> ·
                <a href="https://www.wikidata.org/wiki/Wikidata:Main_Page" target="_blank" rel="noopener">Wikidata</a>
            </div>
        </footer>
    </div>

    <!-- External libs -->
    <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
    <script src="https://unpkg.com/gsap@3.12.5/dist/gsap.min.js"></script>

    <script>// CONFIG — set your endpoints or keys here. Works without keys using Wikipedia & Commons.
    const CONFIG = {
      WIKI_SEARCH: 'https://en.wikipedia.org/w/api.php?action=query&list=search&format=json&origin=*&srsearch=',
      WIKI_SUMMARY: 'https://en.wikipedia.org/api/rest_v1/page/summary/',
      COMMONS_IMAGE: 'https://en.wikipedia.org/w/api.php?action=query&prop=pageimages&format=json&origin=*&piprop=original&titles=',
      GBIF_SPECIES: 'https://api.gbif.org/v1/species/search?q=',
      AI_ENDPOINT: '', // e.g., '/api/ai' or a proxy to your AI provider
      AI_HEADERS: {},  // e.g., { 'Authorization': 'Bearer ...', 'Content-Type': 'application/json' }
      PAGE_SIZE: 18,
      INITIAL_THEME: 'lush'
    };

    // Seed forest list: include diverse biomes and locations.
    const FORESTS = [
      { name: 'Amazon rainforest', biome: 'tropical', place: 'South America', wd: 'Q40285' },
      { name: 'Congo rainforest', biome: 'tropical', place: 'Central Africa', wd: 'Q193689' },
      { name: 'Daintree rainforest', biome: 'tropical', place: 'Queensland, Australia', wd: 'Q115085' },
      { name: 'Sundarbans mangrove', biome: 'mangrove', place: 'India & Bangladesh', wd: 'Q12372' },
      { name: 'Tongass National Forest', biome: 'temperate', place: 'Alaska, USA', wd: 'Q141536' },
      { name: 'Black Forest', biome: 'temperate', place: 'Germany', wd: 'Q1530' },
      { name: 'Białowieża Forest', biome: 'temperate', place: 'Poland & Belarus', wd: 'Q7083' },
      { name: 'Yakushima forest', biome: 'temperate', place: 'Japan', wd: 'Q793148' },
      { name: 'Hoh Rain Forest', biome: 'temperate', place: 'Washington, USA', wd: 'Q1302106' },
      { name: 'Valdivian temperate rainforest', biome: 'temperate', place: 'Chile & Argentina', wd: 'Q658631' },
      { name: 'Taiga', biome: 'boreal', place: 'Canada & Russia & Scandinavia', wd: 'Q25740' },
      { name: 'Great Bear Rainforest', biome: 'temperate', place: 'British Columbia, Canada', wd: 'Q1532041' },
      { name: 'Aokigahara Forest', biome: 'temperate', place: 'Japan', wd: 'Q83510' },
      { name: 'Sinharaja Forest', biome: 'tropical', place: 'Sri Lanka', wd: 'Q256916' },
      { name: 'Monteverde Cloud Forest', biome: 'cloud', place: 'Costa Rica', wd: 'Q2063566' },
      { name: 'Bwindi Impenetrable Forest', biome: 'tropical', place: 'Uganda', wd: 'Q968034' },
      { name: 'Taman Negara', biome: 'tropical', place: 'Malaysia', wd: 'Q190593' },
      { name: 'Eastern Himalayas forests', biome: 'cloud', place: 'Bhutan, India, Nepal', wd: 'Q3321427' },
      { name: 'Chilika coastal forests', biome: 'mangrove', place: 'Odisha, India', wd: 'Q3320266' },
      { name: 'Gir Forest', biome: 'temperate', place: 'Gujarat, India', wd: 'Q127854' },
      { name: 'Nilgiri Biosphere Reserve', biome: 'temperate', place: 'Tamil Nadu, Kerala, Karnataka, India', wd: 'Q1550815' },
      { name: 'Western Ghats forests', biome: 'tropical', place: 'India', wd: 'Q180588' },
      { name: 'Kalakad Mundanthurai tiger reserve', biome: 'tropical', place: 'Tamil Nadu, India', wd: 'Q635374' },
      { name: 'Kaziranga floodplain forests', biome: 'tropical', place: 'Assam, India', wd: 'Q1140048' },
      { name: 'Simlipal Forest', biome: 'tropical', place: 'Odisha, India', wd: 'Q744327' },
      { name: 'Munnar cloud forests', biome: 'cloud', place: 'Kerala, India', wd: 'Q688215' },
      { name: 'Masoala National Park', biome: 'tropical', place: 'Madagascar', wd: 'Q263502' },
      { name: 'Kinabalu montane forest', biome: 'cloud', place: 'Sabah, Malaysia', wd: 'Q170352' },
      { name: 'Yosemite mixed conifer forest', biome: 'temperate', place: 'California, USA', wd: 'Q104238' },
      { name: 'Norwegian boreal forest', biome: 'boreal', place: 'Norway', wd: 'Q1142' }
    ];

    // Benefits catalog — generic, expanded by biome.
    const BENEFITS = {
      tropical: [
        'High biodiversity supports resilient ecosystems.',
        'Carbon sequestration moderates global climate.',
        'Complex canopy regulates local hydrology.',
        'Medicinal plants and cultural value.'
      ],
      temperate: [
        'Seasonal nutrient cycling enriches soils.',
        'Habitat for diverse mammals and birds.',
        'Recreation and mental health benefits.',
        'Sustainable timber with careful management.'
      ],
      boreal: [
        'Largest terrestrial carbon store in soils.',
        'Critical migratory bird breeding grounds.',
        'Climate buffering via albedo and snow interactions.',
        'Wood products and non-timber forest goods.'
      ],
      mangrove: [
        'Coastal protection from storms and erosion.',
        'Nursery habitats for fish and crustaceans.',
        'Blue carbon sinks in sediments.',
        'Livelihoods via sustainable aquaculture.'
      ],
      cloud: [
        'Intercepts mist; feeds streams year-round.',
        'Endemic species in isolated peaks.',
        'Water security for downstream communities.',
        'Ecotourism with low-impact trails.'
      ],
      all: [
        'Air purification and temperature moderation.',
        'Pollinator support and seed dispersal services.'
      ]
    };

    // State
    let page = 0;
    let filter = 'all';
    let query = '';
    let loading = false;
    let revealedCount = 0;
    let activeForest = null;

    // Helpers
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const grid = $('#grid');
    const loader = $('#loader');
    const sentinel = $('#sentinel');

    // Theme handling
    function setTheme(t) {
      document.body.setAttribute('data-theme', t);
      $$('.theme button').forEach(b => b.classList.toggle('active', b.dataset.setTheme === t));
    }
    $$('.theme button').forEach(b => b.addEventListener('click', () => setTheme(b.dataset.setTheme)));
    setTheme(CONFIG.INITIAL_THEME);

    // 3D forest canopy scene
    (function initScene(){
      const canvas = document.getElementById('scene');
      const renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true });
      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(50, innerWidth / innerHeight, 0.1, 100);
      camera.position.set(0, 1.6, 3.6);

      const fog = new THREE.FogExp2(0x0b120c, 0.16);
      scene.fog = fog;

      const ambient = new THREE.AmbientLight(0x8fd39f, 0.45);
      const dir = new THREE.DirectionalLight(0xa0f0c0, 0.55);
      dir.position.set(-2, 3, 2);
      scene.add(ambient, dir);

      const group = new THREE.Group();
      scene.add(group);

      // Ground plane
      const ground = new THREE.Mesh(
        new THREE.PlaneGeometry(20, 20, 1, 1),
        new THREE.MeshStandardMaterial({ color: 0x0d1a10, roughness: 1, metalness: 0 })
      );
      ground.rotation.x = -Math.PI/2;
      ground.position.y = -0.6;
      group.add(ground);

      // Instanced "trees": trunk + canopy cones
      const trunkGeo = new THREE.CylinderGeometry(0.025, 0.04, 0.8, 6);
      const trunkMat = new THREE.MeshStandardMaterial({ color: 0x3b6044, roughness: 0.9 });
      const canopyGeo = new THREE.ConeGeometry(0.22, 0.5, 7);
      const canopyMat = new THREE.MeshStandardMaterial({ color: 0x1f7a42, roughness: 0.6 });

      const trees = new THREE.Group();
      for (let i=0; i<160; i++){
        const t = new THREE.Group();
        const trunk = new THREE.Mesh(trunkGeo, trunkMat);
        trunk.position.y = 0.4;
        const canopy = new THREE.Mesh(canopyGeo, canopyMat);
        canopy.position.y = 0.95;
        canopy.rotation.y = Math.random()*Math.PI;
        t.add(trunk, canopy);
        t.position.set((Math.random()-0.5)*6.6, -0.6, (Math.random()-0.5)*6.6);
        t.scale.setScalar(0.8 + Math.random()*0.6);
        trees.add(t);
      }
      group.add(trees);

      // Floating pollen/particle layer
      const pGeo = new THREE.SphereGeometry(0.008, 6, 6);
      const pMat = new THREE.MeshBasicMaterial({ color: 0x8fffb5, transparent: true, opacity: 0.4 });
      const particles = new THREE.Group();
      for (let i=0;i<200;i++){
        const p = new THREE.Mesh(pGeo, pMat);
        p.position.set((Math.random()-0.5)*6, Math.random()*2.5, (Math.random()-0.5)*6);
        particles.add(p);
      }
      group.add(particles);

      function resize(){
        const w = innerWidth, h = innerHeight;
        renderer.setSize(w, h);
        renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
        camera.aspect = w/h; camera.updateProjectionMatrix();
      }
      addEventListener('resize', resize);
      resize();

      let t = 0;
      function animate(){
        t += 0.005;
        particles.children.forEach((p, i) => {
          p.position.y += Math.sin(t + i*0.2)*0.002 + 0.002;
          if (p.position.y > 3) p.position.y = Math.random()*1.2;
        });
        group.rotation.y = Math.sin(t*0.4)*0.03;
        renderer.render(scene, camera);
        requestAnimationFrame(animate);
      }
      animate();

      // Parallax via mouse
      addEventListener('mousemove', (e)=>{
        const x = (e.clientX / innerWidth - 0.5)*2;
        const y = (e.clientY / innerHeight - 0.5)*2;
        camera.position.x = x*0.4;
        camera.position.y = 1.6 - y*0.2;
      });
    })();

    // Build cards
    function forestToCard(f) {
      const card = document.createElement('div');
      card.className = 'card';
      card.setAttribute('tabindex', '0');
      card.innerHTML = `
        <div class="thumb">
          <img alt="${f.name}" loading="lazy" src="${imageFor(f)}" />
          <div class="overlay"></div>
        </div>
        <div class="meta">
          <div class="name">${f.name}</div>
          <div class="place">${f.place}</div>
          <div class="tags">
            <span class="tag">${f.biome}</span>
            <span class="tag">wildlife</span>
            <span class="tag">canopy</span>
          </div>
          <div class="actions-row">
            <button class="btn btn-open"><svg class="i" viewBox="0 0 24 24"><path fill="currentColor" d="M12 2l8 8l-8 8l-8-8l8-8ZM7 10h10v2H7v-2Z"/></svg>Open</button>
            <button class="btn btn-ask"><svg class="i" viewBox="0 0 24 24"><path fill="currentColor" d="M12 2a9 9 0 0 0-9 9c0 4.97 4.03 9 9 9s9-4.03 9-9s-4.03-9-9-9Zm1 14h-2v-2h2v2Zm2.07-7.75l-.9.92C12.45 9.9 12 10.5 12 12h-2v-.5c0-.8.45-1.5 1.17-2.17l1.24-1.26c.37-.36.59-.86.59-1.41c0-1.1-.9-2-2-2s-2 .9-2 2H7c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25Z"/></svg>Ask AI</button>
          </div>
        </div>
      `;
      card.querySelector('.btn-open').addEventListener('click', () => openDetails(f));
      card.querySelector('.btn-ask').addEventListener('click', () => askAI(`Explain the ecological dynamics of ${f.name} (${f.biome} biome). What makes it unique?`));
      card.addEventListener('keydown', (e)=>{
        if (e.key === 'Enter') openDetails(f);
      });
      return card;
    }

    // Wikimedia-friendly image URL (no API key).
    function imageFor(f){
      const q = encodeURIComponent(f.name);
      // Use a thumbnail page from Wikimedia; fallback to a neutral canopy image.
      return `https://source.unsplash.com/featured/800x450/?forest,${q}`; // Note: For guaranteed free source, replace with Commons images via fetch.
    }

    // Render page
    function applyFilter(list){
      return list.filter(f => filter==='all' ? true : f.biome===filter)
                 .filter(f => query ? f.name.toLowerCase().includes(query.toLowerCase()) : true);
    }

    function renderNext(){
      if (loading) return;
      loading = true; loader.style.display = 'block';
      const start = page * CONFIG.PAGE_SIZE;
      const filtered = applyFilter(FORESTS);
      const slice = filtered.slice(start, start + CONFIG.PAGE_SIZE);
      requestIdleCallback(()=>{
        slice.forEach((f, i)=>{
          const card = forestToCard(f);
          grid.appendChild(card);
          // Reveal animation stagger
          setTimeout(()=> card.classList.add('revealed'), 40 + i*22);
          revealedCount++;
        });
        page++;
        loader.style.display = 'none';
        loading = false;
      });
    }

    // Infinite scroll
    const io = new IntersectionObserver(entries => {
      entries.forEach(e=>{
        if (e.isIntersecting) {
          const filtered = applyFilter(FORESTS);
          if (page * CONFIG.PAGE_SIZE < filtered.length) renderNext();
        }
      });
    });
    io.observe(sentinel);

    // Filters
    $$('.chip').forEach(ch => ch.addEventListener('click', ()=>{
      $$('.chip').forEach(c=> c.classList.toggle('active', c===ch));
      filter = ch.dataset.filter;
      page = 0; revealedCount = 0;
      grid.innerHTML = '';
      renderNext();
    }));

    // Shuffle
    $('#shuffleBtn').addEventListener('click', ()=>{
      FORESTS.sort(()=> Math.random() - 0.5);
      page = 0; revealedCount = 0;
      grid.innerHTML = '';
      renderNext();
    });

    // Search suggestions (local + Wikipedia)
    const searchInput = $('#searchInput');
    const suggestions = $('#suggestions');
    let sugIndex = -1, sugItems = [];
    function openSuggestions(items){
      suggestions.innerHTML = '';
      items.forEach((txt, idx)=>{
        const div = document.createElement('div');
        div.className = 'item';
        div.setAttribute('role', 'option');
        div.textContent = txt;
        div.addEventListener('click', ()=>{
          searchInput.value = txt;
          query = txt;
          page = 0; grid.innerHTML = ''; renderNext();
          closeSuggestions();
        });
        suggestions.appendChild(div);
      });
      sugItems = Array.from(suggestions.children);
      suggestions.classList.add('open');
    }
    function closeSuggestions(){
      suggestions.classList.remove('open');
      suggestions.innerHTML = '';
      sugIndex = -1; sugItems = [];
    }
    function debounce(fn, ms){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); }; }
    const fetchWikiSuggestions = debounce(async (q)=>{
      if (!q || q.length < 2) { closeSuggestions(); return; }
      try {
        const res = await fetch(CONFIG.WIKI_SEARCH + encodeURIComponent(q));
        const json = await res.json();
        const localHits = FORESTS.filter(f=> f.name.toLowerCase().includes(q.toLowerCase())).map(f=> f.name);
        const wikiHits = (json.query?.search || []).map(s=> s.title).filter(title => /forest|rainforest|mangrove|taiga|wood/i.test(title));
        const unique = Array.from(new Set([...localHits, ...wikiHits])).slice(0, 12);
        if (unique.length) openSuggestions(unique); else closeSuggestions();
      } catch(e){ /* silent */ }
    }, 240);

    searchInput.addEventListener('input', (e)=>{
      query = e.target.value;
      page = 0; grid.innerHTML = '';
      renderNext();
      fetchWikiSuggestions(query);
    });
    searchInput.addEventListener('keydown', (e)=>{
      if (!suggestions.classList.contains('open')) return;
      if (e.key === 'ArrowDown') {
        e.preventDefault(); sugIndex = Math.min(sugIndex+1, sugItems.length-1);
      } else if (e.key === 'ArrowUp') {
        e.preventDefault(); sugIndex = Math.max(sugIndex-1, 0);
      } else if (e.key === 'Enter') {
        e.preventDefault(); if (sugItems[sugIndex]) sugItems[sugIndex].click();
      } else if (e.key === 'Escape') {
        closeSuggestions();
      }
      sugItems.forEach((it, idx)=> it.classList.toggle('active', idx===sugIndex));
    });
    document.addEventListener('click', (e)=>{
      if (!suggestions.contains(e.target) && e.target !== searchInput) closeSuggestions();
    });

    // Details panel loading (summary + image + species + benefits)
    async function openDetails(f){
      activeForest = f;
      $('#detailsName').textContent = f.name;
      $('#detailsPlace').textContent = f.place;
      $('#detailsSummary').textContent = 'Loading overview...';
      $('#speciesList').innerHTML = '<li>Loading species...</li>';
      $('#benefitsList').innerHTML = '<li>Loading benefits...</li>';
      $('#wikiLink').href = `https://en.wikipedia.org/wiki/${encodeURIComponent(f.name.replace(/\s/g,'_'))}`;
      $('#commonsLink').href = `https://commons.wikimedia.org/wiki/Special:MediaSearch?type=image&go=Go&ns=6&search=${encodeURIComponent(f.name)}`;

      // Summary
      try {
        const res = await fetch(CONFIG.WIKI_SUMMARY + encodeURIComponent(f.name.replace(/\s/g,'_')));
        const json = await res.json();
        $('#detailsSummary').textContent = json.extract || 'No summary available.';
        $('#detailsImg').src = (json.originalimage?.source || imageFor(f));
      } catch(e) {
        $('#detailsSummary').textContent = 'No summary available.';
        $('#detailsImg').src = imageFor(f);
      }

      // Species hints via GBIF search
      try {
        const res = await fetch(CONFIG.GBIF_SPECIES + encodeURIComponent(f.name));
        const json = await res.json();
        const results = (json.results || []).filter(r => r.rank === 'SPECIES' || r.rank === 'GENUS').slice(0, 12);
        $('#speciesList').innerHTML = '';
        if (results.length === 0) {
          $('#speciesList').innerHTML = '<li>No species hints available.</li>';
        } else {
          results.forEach(r=>{
            const li = document.createElement('li');
            li.textContent = r.canonicalName || r.scientificName || r.species || 'Unknown';
            $('#speciesList').appendChild(li);
          });
        }
      } catch(e){
        $('#speciesList').innerHTML = '<li>Could not load species.</li>';
      }

      // Benefits by biome
      const b = [...(BENEFITS[f.biome] || []), ...BENEFITS.all];
      $('#benefitsList').innerHTML = '';
      b.forEach(txt=>{
        const li = document.createElement('li');
        li.textContent = txt;
        $('#benefitsList').appendChild(li);
      });

      // Reveal the Overview tab
      switchTab('overview');
    }

    // Tabs
    function switchTab(name){
      $$('.tab').forEach(t=> t.classList.toggle('active', t.dataset.tab === name));
      $$('.tabpanel').forEach(p=> p.classList.toggle('active', p.id === 'tab-' + name));
    }
    $$('.tab').forEach(t=> t.addEventListener('click', ()=> switchTab(t.dataset.tab)));

    // Initial render
    renderNext();

    // AI integration (pluggable)
    function appendAi(role, text){
      const div = document.createElement('div');
      div.className = 'ai-msg ' + (role === 'user' ? 'ai-user' : 'ai-assistant');
      div.textContent = text;
      $('#aiLog').appendChild(div);
      const log = $('#aiLog'); log.scrollTop = log.scrollHeight;
    }
    async function askAI(prompt){
      if (!prompt.trim()) return;
      appendAi('user', prompt);
      if (!CONFIG.AI_ENDPOINT) {
        appendAi('assistant', 'AI endpoint not configured. Set CONFIG.AI_ENDPOINT to enable answers.');
        return;
      }
      try {
        const res = await fetch(CONFIG.AI_ENDPOINT, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', ...CONFIG.AI_HEADERS },
          body: JSON.stringify({
            prompt,
            context: {
              forest: activeForest?.name || null,
              biome: activeForest?.biome || null,
              place: activeForest?.place || null
            }
          })
        });
        // Support simple JSON { answer } or text stream
        const ct = res.headers.get('Content-Type') || '';
        if (ct.includes('application/json')) {
          const json = await res.json();
          appendAi('assistant', json.answer || 'No answer received.');
        } else {
          const reader = res.body.getReader();
          let decoder = new TextDecoder('utf-8'); let buf = '';
          while (true) {
            const { value, done } = await reader.read();
            if (done) break;
            buf += decoder.decode(value, { stream: true });
            // Stream chunk display
            appendAi('assistant', buf);
          }
        }
      } catch(e){
        appendAi('assistant', 'The forest is quiet... but the network failed. Try again.');
      }
    }
    $('#aiSend').addEventListener('click', ()=> askAI($('#aiInput').value));
    $('#aiInput').addEventListener('keydown', (e)=> { if (e.key === 'Enter') askAI($('#aiInput').value); });

    // Accessibility: focus outlines on keyboard use
    let mouseDown = false;
    document.addEventListener('mousedown', ()=> mouseDown = true);
    document.addEventListener('keydown', ()=> mouseDown = false);
    document.addEventListener('focusin', (e)=>{
      if (!mouseDown && e.target.classList) e.target.classList.add('focus-ring');
    });

    // Optional: smooth content reveal when navigating
    gsap.from('.logo .mark', { scale: 0.8, opacity: 0, duration: 0.6, ease: 'power2.out' });
    gsap.from('header', { y: -20, opacity: 0, duration: 0.6, ease: 'power2.out' });
    gsap.from('.searchbar', { y: -20, opacity: 0, duration: 0.7, ease: 'power2.out' });
    gsap.from('.ai', { x: 20, opacity: 0, duration: 0.7, ease: 'power2.out' });</script>
</body>
</html>