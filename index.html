<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forests of the World</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1a0d;
        }

        #bg-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        .content {
            position: relative;
            z-index: 1;
            padding: 2rem;
            color: #d1d5db;
        }

        .scroll-container {
            -webkit-mask-image: linear-gradient(to bottom, transparent 0%, white 5%, white 95%, transparent 100%);
            mask-image: linear-gradient(to bottom, transparent 0%, white 5%, white 95%, transparent 100%);
        }

        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(31, 41, 55, 0.9);
            border: 1px solid rgba(75, 85, 99, 0.8);
            border-radius: 0.75rem;
            padding: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            z-index: 100;
        }

        .glow {
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.6);
        }
    </style>
</head>

<body class="bg-[#121c12]">

    <!-- 3D Background with Three.js -->
    <canvas id="bg-canvas"></canvas>

    <!-- Main content container -->
    <div class="content min-h-screen flex flex-col items-center">
        <!-- Header -->
        <header class="w-full max-w-4xl text-center py-8">
            <h1 class="text-5xl md:text-6xl font-bold text-green-300 drop-shadow-lg animate-pulse">
                Forests of the World
            </h1>
            <p class="mt-4 text-xl text-green-200">
                Explore the lungs of our planet.
            </p>
        </header>

        <!-- Search System -->
        <div class="w-full max-w-lg mt-8 relative">
            <div class="relative">
                <input type="text" id="search-input" placeholder="Search for a forest or tree..."
                       class="w-full px-6 py-4 rounded-full bg-gray-800 text-green-100 placeholder-green-300 focus:outline-none focus:ring-4 focus:ring-green-500/50 transition-all duration-300 glow"
                       autocomplete="off">
                <div id="search-suggestions"
                     class="absolute top-full left-0 w-full mt-2 bg-gray-800 rounded-xl shadow-lg border border-green-700 max-h-60 overflow-y-auto hidden">
                    <!-- Suggestions will be injected here -->
                </div>
            </div>
            <div id="search-results" class="mt-8">
                <!-- Search results will be injected here -->
            </div>
        </div>

        <!-- Infinite Scroll Section -->
        <div class="w-full max-w-4xl mt-16 pb-20">
            <h2 class="text-3xl font-bold text-green-300 mb-8 text-center">Forest Facts & Figures</h2>
            <div id="content-container" class="space-y-8 scroll-container max-h-[60vh] overflow-y-auto">
                <!-- Content cards will be injected here -->
            </div>
            <div id="loading-indicator" class="text-center mt-8 hidden">
                <svg class="animate-spin h-8 w-8 text-green-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none"
                     viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor"
                          d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                    </path>
                </svg>
            </div>
        </div>

        <!-- Custom Message Box -->
        <div id="message-box" class="message-box hidden">
            <div class="text-green-300 font-bold text-xl mb-4" id="message-title"></div>
            <div class="text-gray-300 mb-6" id="message-text"></div>
            <div class="flex justify-end">
                <button id="message-ok-btn"
                        class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-md transition-colors">
                    OK
                </button>
            </div>
        </div>
    </div>

    <!-- Three.js library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        // --- Custom Message Box Functions ---
        function showMessage(title, message) {
            const messageBox = document.getElementById('message-box');
            document.getElementById('message-title').textContent = title;
            document.getElementById('message-text').textContent = message;
            messageBox.classList.remove('hidden');
        }

        function hideMessage() {
            document.getElementById('message-box').classList.add('hidden');
        }

        document.getElementById('message-ok-btn').addEventListener('click', hideMessage);

        // --- Three.js 3D Background ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({
            canvas: document.getElementById('bg-canvas'),
            antialias: true
        });

        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setClearColor(0x121c12, 1);

        // Lights
        const ambientLight = new THREE.AmbientLight(0x404040, 5);
        scene.add(ambientLight);
        const directionalLight = new THREE.DirectionalLight(0xffffff, 2);
        directionalLight.position.set(5, 10, 7.5);
        scene.add(directionalLight);

        // Forest Geometry
        const treeCount = 100;
        const treeGeometry = new THREE.ConeGeometry(0.5, 2, 8);
        const trunkGeometry = new THREE.CylinderGeometry(0.1, 0.1, 1, 8);
        const treeMaterial = new THREE.MeshPhongMaterial({
            color: 0x228b22,
            shininess: 0
        });
        const trunkMaterial = new THREE.MeshPhongMaterial({
            color: 0x5c4033,
            shininess: 0
        });

        // Add a ground plane
        const groundGeometry = new THREE.PlaneGeometry(100, 100);
        const groundMaterial = new THREE.MeshPhongMaterial({
            color: 0x3d523d,
            side: THREE.DoubleSide
        });
        const groundPlane = new THREE.Mesh(groundGeometry, groundMaterial);
        groundPlane.rotation.x = Math.PI / 2;
        groundPlane.position.y = -0.5;
        scene.add(groundPlane);

        // Populate the forest
        for (let i = 0; i < treeCount; i++) {
            const tree = new THREE.Mesh(treeGeometry, treeMaterial);
            const trunk = new THREE.Mesh(trunkGeometry, trunkMaterial);
            const scale = Math.random() * 0.5 + 0.5;
            tree.scale.set(scale, scale, scale);
            trunk.scale.set(scale, scale, scale);

            const x = (Math.random() - 0.5) * 60;
            const z = (Math.random() - 0.5) * 60;

            tree.position.set(x, 1 * scale, z);
            trunk.position.set(x, 0, z);

            scene.add(tree);
            scene.add(trunk);
        }

        camera.position.z = 25;
        camera.position.y = 5;
        camera.rotation.x = -Math.PI / 10;

        function animate() {
            requestAnimationFrame(animate);

            // Simple camera movement for a subtle, floating effect
            camera.position.x = Math.sin(Date.now() * 0.0001) * 2;
            camera.position.y = 5 + Math.sin(Date.now() * 0.0002) * 1;

            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // Start the animation on window load.
        window.onload = function () {
            animate();
        };

        // --- Data for Search and Infinite Scroll (Simulated API) ---
        const forestData = [{
            title: "Amazon Rainforest",
            content: "The Amazon is the world's largest tropical rainforest, famous for its biodiversity. It's home to a tenth of all known species.",
            keywords: "amazon, rainforest, tropical, south america, biodiversity, species",
            imageUrl: "https://placehold.co/600x400/1e592c/ffffff?text=Amazon",
            locationQuery: "Amazon Rainforest, Brazil"
        }, {
            title: "Boreal Forests (Taiga)",
            content: "These are the planet's largest land biome, located in the cold northern climates. Conifers like pine and spruce are dominant.",
            keywords: "boreal, taiga, canada, russia, northern, conifer, pine, spruce",
            imageUrl: "https://placehold.co/600x400/213532/ffffff?text=Taiga",
            locationQuery: "Boreal Forest"
        }, {
            title: "Sequoia Trees",
            content: "Giant Sequoias are the world's most massive trees, known for their incredible size and longevity. They are found in California's Sierra Nevada mountains.",
            keywords: "sequoia, giant, tree, california, sierra nevada, massive, longevity",
            imageUrl: "https://placehold.co/600x400/4a3c26/ffffff?text=Sequoia+Tree",
            locationQuery: "Sequoia National Park, California"
        }, {
            title: "Black Forest",
            content: "Located in southwestern Germany, the Black Forest is known for its dense, evergreen forests and picturesque villages. It's the setting for many fairy tales.",
            keywords: "black forest, germany, evergreen, fairy tales, pine",
            imageUrl: "https://placehold.co/600x400/1c1f1d/ffffff?text=Black+Forest",
            locationQuery: "Black Forest, Germany"
        }, {
            title: "Temperate Deciduous Forests",
            content: "These forests are characterized by trees that lose their leaves in the fall. They are found in regions with four distinct seasons.",
            keywords: "temperate, deciduous, seasons, leaves, autumn",
            imageUrl: "https://placehold.co/600x400/58784d/ffffff?text=Deciduous",
            locationQuery: "Temperate Deciduous Forest"
        }, {
            title: "Coastal Redwood",
            content: "The tallest trees on Earth, Coastal Redwoods thrive in the humid, foggy climate of Northern California. They can live for over 2,000 years.",
            keywords: "coastal redwood, tallest, tree, california, humid, foggy",
            imageUrl: "https://placehold.co/600x400/2f2a24/ffffff?text=Coastal+Redwood",
            locationQuery: "Coastal Redwood, California"
        }, {
            title: "Mangrove Forests",
            content: "These are unique coastal ecosystems found in tropical and subtropical regions. Their salt-tolerant trees protect coastlines from erosion.",
            keywords: "mangrove, coastal, ecosystem, tropical, salt-tolerant, erosion",
            imageUrl: "https://placehold.co/600x400/406159/ffffff?text=Mangrove",
            locationQuery: "Mangrove Forest"
        }, {
            title: "Yosemite National Park",
            content: "Yosemite is famous for its granite cliffs and giant sequoia groves. It is a stunning example of a mixed-conifer forest.",
            keywords: "yosemite, national park, granite, cliffs, sequoia, conifer",
            imageUrl: "https://placehold.co/600x400/7a7f6f/ffffff?text=Yosemite",
            locationQuery: "Yosemite National Park, California"
        },];

        // --- Search Functionality ---
        const searchInput = document.getElementById('search-input');
        const searchSuggestions = document.getElementById('search-suggestions');
        const searchResults = document.getElementById('search-results');

        function searchForests(query) {
            if (!query) return [];
            const lowerQuery = query.toLowerCase();
            return forestData.filter(item =>
                item.title.toLowerCase().includes(lowerQuery) ||
                item.content.toLowerCase().includes(lowerQuery) ||
                item.keywords.toLowerCase().includes(lowerQuery)
            );
        }

        searchInput.addEventListener('input', (e) => {
            const query = e.target.value.trim();
            if (query.length > 0) {
                const results = searchForests(query);
                displaySuggestions(results);
            } else {
                hideSuggestions();
            }
        });

        function performSearch(query) {
            hideSuggestions();
            const results = searchForests(query);
            displayResults(results);
        }

        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                performSearch(e.target.value);
            }
        });

        function displaySuggestions(results) {
            searchSuggestions.innerHTML = '';
            if (results.length > 0) {
                results.forEach(item => {
                    const suggestionDiv = document.createElement('div');
                    suggestionDiv.textContent = item.title;
                    suggestionDiv.className = 'px-4 py-3 cursor-pointer hover:bg-green-700/50 transition-colors rounded-lg m-2';
                    suggestionDiv.addEventListener('click', () => {
                        searchInput.value = item.title;
                        performSearch(item.title);
                    });
                    searchSuggestions.appendChild(suggestionDiv);
                });
                searchSuggestions.classList.remove('hidden');
            } else {
                hideSuggestions();
            }
        }

        function hideSuggestions() {
            searchSuggestions.classList.add('hidden');
            searchSuggestions.innerHTML = '';
        }

        function displayResults(results) {
            searchResults.innerHTML = '';
            if (results.length > 0) {
                results.forEach(item => {
                    const resultDiv = document.createElement('div');
                    const normalizedTitle = item.title.replace(/\s/g, '-');
                    resultDiv.className = 'bg-gray-800 border border-green-700 rounded-lg p-6 mb-4 animate-fade-in transition-all duration-300 transform hover:scale-[1.01] glow';
                    resultDiv.innerHTML = `
                            <img src="${item.imageUrl}" alt="${item.title}" class="rounded-lg mb-4 w-full h-48 object-cover">
                            <h3 class="text-xl font-bold text-green-300">${item.title}</h3>
                            <p class="mt-2 text-gray-300">${item.content}</p>
                            <div class="mt-4 flex justify-end">
                                <button class="explore-button px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-md transition-colors" data-topic="${item.title}" data-location="${item.locationQuery}">
                                    ✨ Explore with AI & Maps
                                </button>
                            </div>
                            <div id="ai-result-container-${normalizedTitle}" class="mt-6 hidden">
                                <div class="flex flex-col md:flex-row gap-6">
                                    <div id="ai-text-result-${normalizedTitle}" class="md:w-1/2"></div>
                                    <div id="ai-map-result-${normalizedTitle}" class="md:w-1/2 h-64 md:h-96 rounded-lg overflow-hidden border border-green-700"></div>
                                </div>
                            </div>
                        `;
                    searchResults.appendChild(resultDiv);
                });
                attachExploreListeners();
            } else {
                searchResults.innerHTML = '<p class="text-gray-400 text-center">No results found. Try a different search term!</p>';
            }
        }

        // --- Gemini API & Google Maps Integration ---
        async function exploreForest(topic, locationQuery, button) {
            const normalizedTitle = topic.replace(/\s/g, '-');
            const resultContainer = document.getElementById(`ai-result-container-${normalizedTitle}`);
            const textResultDiv = document.getElementById(`ai-text-result-${normalizedTitle}`);
            const mapResultDiv = document.getElementById(`ai-map-result-${normalizedTitle}`);
            const originalButtonText = button.textContent;

            // Toggle visibility
            if (resultContainer.classList.contains('hidden')) {
                resultContainer.classList.remove('hidden');
            } else {
                resultContainer.classList.add('hidden');
                return;
            }

            button.textContent = 'Generating...';
            button.disabled = true;
            textResultDiv.innerHTML = `<p class="text-green-500 text-center mt-4">Fetching up-to-date information...</p>`;
            mapResultDiv.innerHTML = `<p class="text-green-500 text-center mt-4">Loading map...</p>`;

            // Create and inject the Google Maps iframe
            const mapsApiKey = "YOUR_GOOGLE_MAPS_API_KEY"; // NOTE: Replace with your actual Google Maps API Key
            const mapUrl = `https://www.google.com/maps/embed/v1/place?key=${mapsApiKey}&q=${encodeURIComponent(locationQuery)}`;
            mapResultDiv.innerHTML = `<iframe width="100%" height="100%" frameborder="0" style="border:0" src="${mapUrl}" allowfullscreen></iframe>`;

            // Gemini API call
            let retryCount = 0;
            const maxRetries = 3;
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const systemPrompt = `You are an expert in ecology and forestry. Provide a comprehensive, factual, and easy-to-understand summary about ${topic}. Focus on key characteristics, geographical location, unique species (if applicable), and its current situation, including conservation status and major threats. Format your response as a single, well-structured paragraph.`;
            const userQuery = `Provide detailed information on ${topic} and its current situation.`;

            async function fetchWithExponentialBackoff() {
                try {
                    const payload = {
                        contents: [{
                            parts: [{
                                text: userQuery
                            }]
                        }],
                        tools: [{
                            "google_search": {}
                        }],
                        systemInstruction: {
                            parts: [{
                                text: systemPrompt
                            }]
                        },
                    };
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && retryCount < maxRetries) {
                            const delay = Math.pow(2, retryCount) * 1000;
                            retryCount++;
                            return new Promise(resolve => setTimeout(() => resolve(fetchWithExponentialBackoff()), delay));
                        }
                        throw new Error(`API call failed with status: ${response.status}`);
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        const text = candidate.content.parts[0].text;
                        textResultDiv.innerHTML = `<p>${text}</p>`;

                        const groundingMetadata = candidate.groundingMetadata;
                        if (groundingMetadata && groundingMetadata.groundingAttributions) {
                            const sources = groundingMetadata.groundingAttributions
                                .map(attribution => ({
                                    uri: attribution.web?.uri,
                                    title: attribution.web?.title,
                                }))
                                .filter(source => source.uri && source.title);

                            if (sources.length > 0) {
                                let sourcesHtml = `<div class="mt-4 text-xs text-gray-500">Sources:<ul>`;
                                sources.forEach(source => {
                                    sourcesHtml += `<li><a href="${source.uri}" target="_blank" class="hover:underline">${source.title}</a></li>`;
                                });
                                sourcesHtml += `</ul></div>`;
                                textResultDiv.innerHTML += sourcesHtml;
                            }
                        }
                    } else {
                        textResultDiv.innerHTML = '<p class="text-red-400">Could not retrieve information. Please try again.</p>';
                    }
                } catch (error) {
                    textResultDiv.innerHTML = `<p class="text-red-400">An error occurred: ${error.message}.</p>`;
                } finally {
                    button.textContent = originalButtonText;
                    button.disabled = false;
                }
            }
            fetchWithExponentialBackoff();
        }

        function attachExploreListeners() {
            document.querySelectorAll('.explore-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const topic = e.target.getAttribute('data-topic');
                    const locationQuery = e.target.getAttribute('data-location');
                    exploreForest(topic, locationQuery, e.target);
                });
            });
        }


        // --- Infinite Scroll Functionality ---
        const contentContainer = document.getElementById('content-container');
        const loadingIndicator = document.getElementById('loading-indicator');
        const observer = new IntersectionObserver(handleIntersection, {
            root: contentContainer,
            threshold: 0.1
        });
        const allContent = forestData.slice();
        let contentIndex = 0;

        function loadMoreContent() {
            loadingIndicator.classList.remove('hidden');
            setTimeout(() => {
                const batchSize = 3;
                for (let i = 0; i < batchSize && contentIndex < allContent.length; i++) {
                    const item = allContent[contentIndex];
                    const contentCard = document.createElement('div');
                    contentCard.className = 'bg-gray-800 border border-green-700 rounded-lg p-6 glow';
                    contentCard.innerHTML = `
                            <img src="${item.imageUrl}" alt="${item.title}" class="rounded-lg mb-4 w-full h-48 object-cover">
                            <h3 class="text-xl font-bold text-green-300">${item.title}</h3>
                            <p class="mt-2 text-gray-300">${item.content}</p>
                        `;
                    contentContainer.appendChild(contentCard);
                    contentIndex++;
                }

                loadingIndicator.classList.add('hidden');

                if (contentIndex < allContent.length) {
                    observer.unobserve(contentContainer.lastElementChild);
                    observer.observe(contentContainer.lastElementChild);
                } else {
                    observer.disconnect();
                }
            }, 1000);
        }

        function handleIntersection(entries) {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    loadMoreContent();
                }
            });
        }

        loadMoreContent();
        observer.observe(contentContainer);
    </script>
</body>

</html>
